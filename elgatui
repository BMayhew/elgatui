#!/bin/bash
# elgatui - Elgato Key Light Terminal UI
# Usage: elgatui [command]
# Commands: on, off, day, night, meeting, interrogation, status, toggle, menu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/config.sh"

# Load config
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: config.sh not found at $CONFIG_FILE"
    echo "Please copy config.example.sh to config.sh and set your IP address."
    exit 1
fi
source "$CONFIG_FILE"

BASE_URL="http://${ELGATO_IP}:${ELGATO_PORT}/elgato"

# Colors
BLACK='\033[0;30m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Bright colors
BRED='\033[1;31m'
BGREEN='\033[1;32m'
BYELLOW='\033[1;33m'
BBLUE='\033[1;34m'
BMAGENTA='\033[1;35m'
BCYAN='\033[1;36m'
BWHITE='\033[1;37m'

# API Functions
get_status() {
    curl -s --connect-timeout 2 "${BASE_URL}/lights" 2>/dev/null
}

set_light() {
    local on="$1"
    local brightness="$2"
    local temperature="$3"

    local body="{\"numberOfLights\":1,\"lights\":[{"
    local first=true

    if [[ -n "$on" ]]; then
        body+="\"on\":$on"
        first=false
    fi
    if [[ -n "$brightness" ]]; then
        [[ "$first" == false ]] && body+=","
        body+="\"brightness\":$brightness"
        first=false
    fi
    if [[ -n "$temperature" ]]; then
        [[ "$first" == false ]] && body+=","
        body+="\"temperature\":$temperature"
    fi
    body+="}]}"

    curl -s --connect-timeout 2 -X PUT "${BASE_URL}/lights" \
        -H "Content-Type: application/json" \
        -d "$body" 2>/dev/null
}

# Visual helpers
draw_bar() {
    local value=$1
    local max=$2
    local width=$3
    local fill_char="$4"
    local empty_char="$5"
    local color="$6"

    local filled=$((value * width / max))
    local empty=$((width - filled))

    echo -en "${color}"
    for ((i=0; i<filled; i++)); do echo -n "$fill_char"; done
    echo -en "${DIM}"
    for ((i=0; i<empty; i++)); do echo -n "$empty_char"; done
    echo -en "${NC}"
}

# Temperature color (warm=red/orange, cool=blue/cyan)
get_temp_color() {
    local temp=$1
    if [[ $temp -lt 180 ]]; then
        echo -en "${BRED}"
    elif [[ $temp -lt 220 ]]; then
        echo -en "${BYELLOW}"
    elif [[ $temp -lt 280 ]]; then
        echo -en "${BWHITE}"
    elif [[ $temp -lt 320 ]]; then
        echo -en "${BCYAN}"
    else
        echo -en "${BBLUE}"
    fi
}

get_temp_label() {
    local temp=$1
    if [[ $temp -lt 180 ]]; then
        echo "VERY WARM"
    elif [[ $temp -lt 220 ]]; then
        echo "WARM"
    elif [[ $temp -lt 280 ]]; then
        echo "NEUTRAL"
    elif [[ $temp -lt 320 ]]; then
        echo "COOL"
    else
        echo "VERY COOL"
    fi
}

draw_header() {
    clear
    echo -e "${BCYAN}"
    echo '  ╔═════════════════════════════════════════════════════════════════════════════════════════════════════════╗'
    echo -e "  ║  ${BWHITE}███████╗██╗      ██████╗  █████╗ ████████╗██╗   ██╗██╗${BCYAN}           ${BYELLOW}★${BCYAN} ${BWHITE}K E Y   L I G H T   C O N T R O L${BCYAN} ${BYELLOW}★${BCYAN} ║"
    echo -e "  ║  ${BWHITE}██╔════╝██║     ██╔════╝ ██╔══██╗╚══██╔══╝██║   ██║██║${BCYAN}                                                 ║"
    echo -e "  ║  ${BWHITE}█████╗  ██║     ██║  ███╗███████║   ██║   ██║   ██║██║${BCYAN}                                                 ║"
    echo -e "  ║  ${BWHITE}██╔══╝  ██║     ██║   ██║██╔══██║   ██║   ██║   ██║██║${BCYAN}                                                 ║"
    echo -e "  ║  ${BWHITE}███████╗███████╗╚██████╔╝██║  ██║   ██║   ╚██████╔╝██║${BCYAN}                                                 ║"
    echo -e "  ║  ${BWHITE}╚══════╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝${BCYAN}                                                 ║"
    echo '  ╚═════════════════════════════════════════════════════════════════════════════════════════════════════════╝'
    echo -e "${NC}"
}

draw_main_panel() {
    local response=$(get_status)
    if [[ -z "$response" ]]; then
        echo -e "  ${BRED}!! CONNECTION ERROR !! ${NC}${DIM}Could not reach ${ELGATO_IP}${NC}"
        return 1
    fi

    local on=$(echo "$response" | grep -o '"on":[0-9]*' | cut -d: -f2)
    local brightness=$(echo "$response" | grep -o '"brightness":[0-9]*' | cut -d: -f2)
    local temperature=$(echo "$response" | grep -o '"temperature":[0-9]*' | cut -d: -f2)
    local kelvin=$((temperature * 29))
    local temp_label=$(get_temp_label "$temperature")

    # Power indicator
    local power_display power_text
    if [[ "$on" == "1" ]]; then
        power_display="${BGREEN}[  O N  ]${NC}"
        power_text="[  O N  ]"
    else
        power_display="${BRED}[ O F F ]${NC}"
        power_text="[ O F F ]"
    fi

    # Build bars
    local bright_bar=$(draw_bar "$brightness" 100 15 "█" "░" "${BYELLOW}")
    local temp_normalized=$(( (temperature - 143) * 100 / 201 ))
    local temp_color=$(get_temp_color "$temperature")

    # Calculate padding for variable content (col 1 = 41 chars)
    local bright_text="${brightness}%"
    local bright_pad=$((14 - ${#bright_text}))  # 41 - 27 (prefix+bar) = 14 for value+padding
    local temp_info="${temp_label} ~${kelvin}K"
    local temp_pad=$((32 - ${#temp_info}))  # 41 - 9 (prefix spaces) = 32 for value+padding

    echo -e "  ${BCYAN}╔═════════════════════════════════════════╦═══════════════════════════════╦═══════════════════════════════╗${NC}"
    echo -e "  ${BCYAN}║${NC}  ${BWHITE}S T A T U S${NC}                            ${BCYAN}║${NC} ${BWHITE}C O M M A N D S${NC}               ${BCYAN}║${NC}  ${BWHITE}P R E S E T S${NC}                ${BCYAN}║${NC}"
    echo -e "  ${BCYAN}╠═════════════════════════════════════════╬═══════════════════════════════╬═══════════════════════════════╣${NC}"
    echo -e "  ${BCYAN}║${NC}                                         ${BCYAN}║${NC}                               ${BCYAN}║${NC}                               ${BCYAN}║${NC}"
    echo -e "  ${BCYAN}║${NC}  POWER   ${power_display}                      ${BCYAN}║${NC}   ${BGREEN}[1]${NC} Power ON                ${BCYAN}║${NC}   ${BYELLOW}[4]${NC} Day   ${DIM}(bright/cool)${NC}     ${BCYAN}║${NC}"
    echo -e "  ${BCYAN}║${NC}                                         ${BCYAN}║${NC}   ${BRED}[2]${NC} Power OFF               ${BCYAN}║${NC}   ${BYELLOW}[5]${NC} Night ${DIM}(dim/warm)${NC}        ${BCYAN}║${NC}"
    printf "  ${BCYAN}║${NC}  ${BYELLOW}BRIGHT${NC} [${bright_bar}] ${BWHITE}%s${NC}%*s${BCYAN}║${NC}   ${BCYAN}[3]${NC} Toggle                  ${BCYAN}║${NC}   ${BYELLOW}[6]${NC} Meeting ${DIM}(balanced)${NC}      ${BCYAN}║${NC}\n" "$bright_text" "$bright_pad" ""
    echo -e "  ${BCYAN}║${NC}                                         ${BCYAN}║${NC}                               ${BCYAN}║${NC}   ${BWHITE}[7]${NC} Interrogation ${DIM}(MAX!)${NC}   ${BCYAN}║${NC}"
    printf "  ${BCYAN}║${NC}  ${temp_color}TEMP${NC}   ["
    draw_bar "$temp_normalized" 100 15 "█" "░" "${temp_color}"
    printf "]               ${BCYAN}║${NC}   ${BWHITE}[R]${NC} Refresh                 ${BCYAN}║${NC}                               ${BCYAN}║${NC}\n"
    printf "  ${BCYAN}║${NC}         ${temp_color}%s${NC}%*s${BCYAN}║${NC}   ${DIM}[Q]${NC} Quit                    ${BCYAN}║${NC}                               ${BCYAN}║${NC}\n" "$temp_info" "$temp_pad" ""
    echo -e "  ${BCYAN}║${NC}                                         ${BCYAN}║${NC}                               ${BCYAN}║${NC}                               ${BCYAN}║${NC}"
    echo -e "  ${BCYAN}╚═════════════════════════════════════════╩═══════════════════════════════╩═══════════════════════════════╝${NC}"
}

show_action() {
    local msg="$1"
    local color="$2"
    echo -e "  ${color}>>> ${msg} <<<${NC}"
    sleep 0.3
}

# Command Functions
cmd_status() {
    local response=$(get_status)
    if [[ -z "$response" ]]; then
        echo -e "${RED}Could not connect to Key Light at ${ELGATO_IP}${NC}"
        return 1
    fi

    local on=$(echo "$response" | grep -o '"on":[0-9]*' | cut -d: -f2)
    local brightness=$(echo "$response" | grep -o '"brightness":[0-9]*' | cut -d: -f2)
    local temperature=$(echo "$response" | grep -o '"temperature":[0-9]*' | cut -d: -f2)

    echo -e "${BCYAN}Elgato Key Light Status${NC}"
    echo "------------------------"
    if [[ "$on" == "1" ]]; then
        echo -e "Power:       ${GREEN}ON${NC}"
    else
        echo -e "Power:       ${RED}OFF${NC}"
    fi
    echo -en "Brightness:  ${brightness}% ["
    draw_bar "$brightness" 100 20 "█" "░" "${BYELLOW}"
    echo "]"
    echo -en "Temperature: ${temperature} ["
    draw_bar "$((temperature - 143))" 201 20 "█" "░" "$(get_temp_color $temperature)"
    echo "]"
}

cmd_on() {
    echo -e "${BGREEN}>>> POWERING ON <<<${NC}"
    set_light 1 "" "" > /dev/null
}

cmd_off() {
    echo -e "${BRED}>>> POWERING OFF <<<${NC}"
    set_light 0 "" "" > /dev/null
}

cmd_toggle() {
    local response=$(get_status)
    local on=$(echo "$response" | grep -o '"on":[0-9]*' | cut -d: -f2)

    if [[ "$on" == "1" ]]; then
        cmd_off
    else
        cmd_on
    fi
}

cmd_day() {
    echo -e "${BYELLOW}>>> DAY MODE <<<${NC}"
    set_light 1 "$PRESET_DAY_BRIGHTNESS" "$PRESET_DAY_TEMPERATURE" > /dev/null
}

cmd_night() {
    echo -e "${BYELLOW}>>> NIGHT MODE <<<${NC}"
    set_light 1 "$PRESET_NIGHT_BRIGHTNESS" "$PRESET_NIGHT_TEMPERATURE" > /dev/null
}

cmd_meeting() {
    echo -e "${BYELLOW}>>> MEETING MODE <<<${NC}"
    set_light 1 "$PRESET_MEETING_BRIGHTNESS" "$PRESET_MEETING_TEMPERATURE" > /dev/null
}

cmd_interrogation() {
    echo -e "${BWHITE}>>> INTERROGATION MODE <<<${NC}"
    set_light 1 "$PRESET_INTERROGATION_BRIGHTNESS" "$PRESET_INTERROGATION_TEMPERATURE" > /dev/null
}

cmd_set() {
    local brightness="$1"
    local temperature="$2"

    if [[ -z "$brightness" ]]; then
        echo "Usage: elgatui set <brightness> [temperature]"
        echo "  brightness: 0-100"
        echo "  temperature: 143-344 (optional)"
        return 1
    fi

    echo -e "${BCYAN}>>> SETTING VALUES <<<${NC}"
    if [[ -n "$temperature" ]]; then
        set_light 1 "$brightness" "$temperature" > /dev/null
    else
        set_light 1 "$brightness" "" > /dev/null
    fi
}

show_menu() {
    while true; do
        draw_header
        draw_main_panel
        echo ""
        read -n 1 -s choice

        case "$choice" in
            1) show_action "POWERING ON" "$BGREEN"; set_light 1 "" "" > /dev/null ;;
            2) show_action "POWERING OFF" "$BRED"; set_light 0 "" "" > /dev/null ;;
            3)
                local response=$(get_status)
                local on=$(echo "$response" | grep -o '"on":[0-9]*' | cut -d: -f2)
                if [[ "$on" == "1" ]]; then
                    show_action "POWERING OFF" "$BRED"
                    set_light 0 "" "" > /dev/null
                else
                    show_action "POWERING ON" "$BGREEN"
                    set_light 1 "" "" > /dev/null
                fi
                ;;
            4) show_action "DAY MODE ACTIVATED" "$BYELLOW"; set_light 1 "$PRESET_DAY_BRIGHTNESS" "$PRESET_DAY_TEMPERATURE" > /dev/null ;;
            5) show_action "NIGHT MODE ACTIVATED" "$BYELLOW"; set_light 1 "$PRESET_NIGHT_BRIGHTNESS" "$PRESET_NIGHT_TEMPERATURE" > /dev/null ;;
            6) show_action "MEETING MODE ACTIVATED" "$BYELLOW"; set_light 1 "$PRESET_MEETING_BRIGHTNESS" "$PRESET_MEETING_TEMPERATURE" > /dev/null ;;
            7) show_action "WHERE WERE YOU LAST NIGHT?!" "$BWHITE"; set_light 1 "$PRESET_INTERROGATION_BRIGHTNESS" "$PRESET_INTERROGATION_TEMPERATURE" > /dev/null ;;
            r|R) ;;
            q|Q) clear; echo -e "${BCYAN}GAME OVER - Thanks for playing!${NC}"; exit 0 ;;
            *) show_action "INVALID COMMAND" "$BRED" ;;
        esac
    done
}

show_help() {
    echo -e "${BCYAN}elgatui - Elgato Key Light Terminal UI${NC}"
    echo ""
    echo "Usage: elgatui [command]"
    echo ""
    echo "Commands:"
    echo "  on       Turn light on (keeps current brightness/temp)"
    echo "  off      Turn light off"
    echo "  toggle   Toggle light on/off"
    echo "  day      Day preset (bright, cool light)"
    echo "  night    Night preset (dim, warm light)"
    echo "  meeting  Meeting preset (balanced for video calls)"
    echo "  interrogation  Interrogation preset (MAX brightness, coldest temp)"
    echo "  status   Show current light status"
    echo "  set <brightness> [temp]  Set custom values"
    echo "  menu     Interactive menu mode"
    echo "  help     Show this help"
    echo ""
    echo "No command opens interactive menu."
}

# Main
case "${1:-menu}" in
    on)      cmd_on ;;
    off)     cmd_off ;;
    toggle)  cmd_toggle ;;
    day)     cmd_day ;;
    night)   cmd_night ;;
    meeting) cmd_meeting ;;
    interrogation) cmd_interrogation ;;
    status)  cmd_status ;;
    set)     cmd_set "$2" "$3" ;;
    menu)    show_menu ;;
    help|-h|--help) show_help ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
